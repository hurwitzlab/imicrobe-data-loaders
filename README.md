# iMicrobe Data Loaders (now with muSCOPE)
Scripts to load various data into the iMicrobe and muSCOPE databases.

  + camera_envo
  + uproc

## camera_envo
Load CAMERA metadata.


## loader/imicrobe/uproc
Scripts to load UProC results into the iMicrobe database.

Run copy_uproc_results_to_iplant_imicrobe.py on Stampede2.

Run load.py on myo.

### Requirements
These scripts require a Python 3.6+ interpreter, `make`, and iRODS iCommands.

### Installation and Usage

#### Stampede2

Copying files from Stampede2 to /iplant/home/shared/imicrobe/ can take a long
time.

```
$ module load python3
$ python3 -m venv ~/imdl
$ source ~/imdl/bin/activate
(imdl) $ git clone https://github.com/hurwitzlab/imicrobe-data-loaders.git
(imdl) $ cd imicrobe-data-loaders
(imdl) $ pip install -r requirements.txt
(imdl) $ make copy-uproc-results-to-irods
```

#### Myo

Use a virtual environment for greatest happiness. All Python requirements will
be installed automatically.

Loading the database tables can take a long time. Consider using `screen`.

```
$ screen
$ python3.6 -m venv ~/imdl
$ source ~/imdl/bin/activate
(imdl) $ git clone https://github.com/hurwitzlab/imicrobe-data-loaders.git
(imdl) $ cd imicrobe-data-loaders
(imdl) $ pip install -r requirements.txt
(imdl) $ write_models -o loader/imicrobe/models.py -u mysql+pymysql://imicrobe:<password>@localhost/imicrobe
##(imdl) $ write_models -o loader/muscope/models.py -u mysql+pymysql://imicrobe:<password>@localhost/muscope2
(imdl) $ cd loader/imicrobe/uproc
(imdl) $ make load-all-tables
```



## imicrobe-load-uproc-results
REPLACED BY loader/imicrobe/uproc
Scripts to load UProC results into the iMicrobe database.


### Requirements
These scripts require iRODS iCommands, `make`, a Python 3.6+ interpreter,
and ORM classes generated by [orminator](https://github.com/hurwitzlab/orminator).

### Installation
Use a virtual environment!

```
$ python3.6 -m venv ~/imdl
$ source ~/imdl/bin/activate
(imdl) $ git clone https://github.com/hurwitzlab/imicrobe-data-loaders.git
(imdl) $ cd imicrobe-data-loaders
(imdl) $ pip install -r requirements.txt
(imdl) $ write_models -o imicrobe/models.py -u mysql+pymysql://imicrobe:<password>@localhost/imicrobe
(imdl) $ write_models -o muscope/models.py -u mysql+pymysql://imicrobe:<password>@localhost/muscope2
```

### Usage: load UProC results
First copy the UProC results files from TACC to /iplant/home/shared/imicrobe
storage. On a TACC system such as Stampede2 run `copy_uproc_results_to_iplant_imicrobe.py`:
```
(imdl) $ python loader/imicrobe/uproc/copy_uproc_results_to_iplant_imicrobe.py
```

Next load the UProC results from /iplant/home/shared/imicrobe into the iMicrobe
on myo. The new tables will be created if they do not exist.

```
(imdl) $ python loader/imicrobe/uproc/load.py
```


### Usage: Load UProC Pfam results
Execute `make ils-imicrobe-projects` to create a file list of the iRODS iMicrobe project directories. By default the list will be written to the `data` directory. This step took 83 minutes on a laptop, 4 minutes on myo.

Execute `make write-download-command-file` to create a file of `iget` commands suitable for GNU `parallel`.

Execute `make parallel-iget-uproc-results` to do the deed. This should take less than an hour. Try `-j 100` for fun.

Execute `make download-pfam-data` to get the necessary Pfam files.

Execute `python load_pfam_table.py` to load Pfam annotations into the uproc table.
This will first drop the uproc table and delete all rows from the sample_to_uproc table.

Run `make write-load-sample-to-uproc-command-file` to create a file of commands for
GNU Parallel. This will also drop and create the sample_to_uproc table.

Run 'make parallel-load-sample-to-uproc' to load the sample_to_uproc table.

### Usage: Load UProC KEGG results

If UProC KEGG results need to be copied from TACC to /iplant/ execute `make copy-uproc-kegg-results-to-iplant` from stampede2.

If the UProC KEGG results have not been copied to myo execute `make ils-imicrobe-projects write-download-command-file parallel-iget-uproc-results`.

If the UProC KEGG database tables do not exist yet execute `make drop-and-create-uproc-kegg-tables`.

To load the UProC KEGG database tables execute `make write-load-uproc-kegg-tables-command-file` followed by `make `
